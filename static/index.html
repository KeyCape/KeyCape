<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>WebAuthn Demo</title>
    <script src="https://cdn.ogkw.de/static/jquery-3.4.0.min.js"></script>
    <link rel="stylesheet" href="https://cdn.ogkw.de/static/tailwindcss.css">
    </link>
</head>

<body class="dark:text-white, dark:bg-slate-800 content-center">
    <div class="w-full max-w-xs md:mx-auto mt-40">
        <div class="bg-slate-600 shadow-md rounded px-8 pt-6 pb-8 mb-4 basis-full">
            <label class="block text-gray-200 text-sm font-bold mb-2" for="username">
                Username
            </label>
            <input
                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                id="email" type="text" placeholder="Username">
            <div class="w-full mb-6 px-4 md:mb-0">
                <button id="btnLogin"
                    class="w-full bg-blue-800 hover:bg-slate-800 text-gray-200 py-2 rounded mt-4 focus:outline-none focus:shadow-outline"
                    onclick="loginUser()">Login</button>
                <button id="btnRegister"
                    class="w-full bg-slate-700 hover:bg-slate-800 text-gray-200 py-2 tracking-wide rounded mt-4 focus:outline-none focus:shadow-outline"
                    onclick="registerUser()">Register</button>
                <button id="btnLogout"
                    class="w-full bg-red-900 hover:bg-slate-800 text-gray-200 py-2 rounded mt-4 focus:outline-none focus:shadow-outline"
                    onclick="deleteToken()">Logout</button>
            </div>
        </div>
        <h1 id="bannerSuccess"
            class="bg-green-700/60 rounded p-4 w-full text-center align-middle font-bold text-gray-300 inline-block mb-4">
            Welcome back user!
        </h1>
        <h1 id="bannerFailure"
            class="bg-red-700/60 rounded p-4 w-full text-center align-middle font-bold text-gray-300 inline-block">
            Welcome back user!
        </h1>
    </div>
    <div class="absolute inset-x-0 bottom-0 h-8 bg-gray-900 font-mono flex flex-row items-center">
        <p class="basis-1/3 text-center align-middle"></p>
        <h1 class=" basis-1/3 bg-slate-900 text-red-700 text-center align-middle">This is a WebAuthn DEMO website!</h1>
        <p class="basis-1/3 text-center align-middle text-red-700"></p>
    </div>
    <script>
        document.getElementById("bannerSuccess").style.display = "none";
        document.getElementById("bannerFailure").style.display = "none";

        function isLoggedIn() {
            $.post('/login/session/status').then((res) => {
                document.getElementById("btnLogout").style.display = "block";
                document.getElementById("btnLogin").style.display = "none";
                document.getElementById("btnRegister").innerText = "Add credential";
            }).fail((res) => {
                document.getElementById("btnLogout").style.display = "none";
                document.getElementById("btnLogin").style.display = "block";
                document.getElementById("btnRegister").innerText = "Register";
            });
        }

        function deleteToken() {
            $.post('/logout').then((res) => {
                isLoggedIn();
            }).fail((res) => { isLoggedIn(); });
            document.getElementById("bannerSuccess").style.display = "block";
            document.getElementById("bannerSuccess").innerText = "Bye";
            document.getElementById("bannerFailure").style.display = "none";

        }

        $(document).ready(function () {

            // check whether current browser supports WebAuthn
            if (!window.PublicKeyCredential) {
                alert("Error: this browser does not support WebAuthn");
                return;
            }
            isLoggedIn();
        });

        // Base64 to ArrayBuffer
        function bufferDecode(value) {
            return Uint8Array.from(atob(value), c => c.charCodeAt(0));
        }

        // ArrayBuffer to URLBase64
        function bufferEncode(value) {
            return btoa(String.fromCharCode.apply(null, new Uint8Array(value)))
                .replace(/\+/g, "-")
                .replace(/\//g, "_")
                .replace(/=/g, "");;
        }

        function registerUser() {

            username = $("#email").val()
            if (username === "") {
                alert("Please enter a username");
                return;
            }

            $.get(
                '/register/begin/' + username,
                null,
                function (data) {
                    return data
                },
                'json')
                .then((credentialCreationOptions) => {
                    console.log(credentialCreationOptions)
                    credentialCreationOptions.challenge = bufferDecode(credentialCreationOptions.challenge);
                    credentialCreationOptions.user.id = bufferDecode(credentialCreationOptions.user.id);
                    if (credentialCreationOptions.excludeCredentials) {
                        for (var i = 0; i < credentialCreationOptions.excludeCredentials.length; i++) {
                            credentialCreationOptions.excludeCredentials[i].id = bufferDecode(credentialCreationOptions.excludeCredentials[i].id);
                        }
                    }

                    return navigator.credentials.create({
                        publicKey: credentialCreationOptions
                    })
                })
                .then((credential) => {
                    console.log(credential)
                    let attestationObject = credential.response.attestationObject;
                    let clientDataJSON = credential.response.clientDataJSON;
                    let rawId = credential.rawId;

                    $.ajax({
                        url: '/register/finish/' + username,
                        type: 'POST', contentType: 'application/json',
                        data: JSON.stringify({
                            id: credential.id,
                            rawId: bufferEncode(rawId),
                            type: credential.type,
                            response: {
                                attestationObject: bufferEncode(attestationObject),
                                clientDataJSON: bufferEncode(clientDataJSON),
                            },
                        }),
                        error: function (xhr, err) {
                            document.getElementById("bannerSuccess").style.display = "none";
                            document.getElementById("bannerFailure").innerText = "Registration failed: " + xhr.responseText;
                            document.getElementById("bannerFailure").style.display = "block";
                            isLoggedIn();
                        },
                        success: function (data, status, xhr) {
                            document.getElementById("bannerFailure").style.display = "none";
                            document.getElementById("bannerSuccess").innerText = "Registration success";
                            document.getElementById("bannerSuccess").style.display = "block";
                            isLoggedIn();
                        }
                    })
                })
                .catch((error) => {
                    document.getElementById("bannerSuccess").style.display = "none";
                    document.getElementById("bannerFailure").innerText = "Registration failed: " + error.responseText;
                    document.getElementById("bannerFailure").style.display = "block";
                    isLoggedIn();
                })
        }

        function loginUser() {

            username = $("#email").val()
            if (username === "") {
                alert("Please enter a username");
                return;
            }

            $.get(
                '/login/begin/' + username,
                null,
                function (data) {
                    return data
                },
                'json')
                .then((credentialRequestOptions) => {
                    console.log(credentialRequestOptions)
                    credentialRequestOptions.challenge = bufferDecode(credentialRequestOptions.challenge);
                    credentialRequestOptions.allowCredentials.forEach(function (listItem) {
                        listItem.id = bufferDecode(listItem.id)
                    });

                    return navigator.credentials.get({
                        publicKey: credentialRequestOptions
                    })
                })
                .then((assertion) => {
                    console.log(assertion)
                    let authData = assertion.response.authenticatorData;
                    let clientDataJSON = assertion.response.clientDataJSON;
                    let rawId = assertion.rawId;
                    let sig = assertion.response.signature;
                    let userHandle = assertion.response.userHandle;

                    $.ajax({
                        url: '/login/finish/' + username,
                        type: 'POST', contentType: 'application/json',
                        data: JSON.stringify({
                            id: assertion.id,
                            rawId: bufferEncode(rawId),
                            type: assertion.type,
                            response: {
                                authenticatorData: bufferEncode(authData),
                                clientDataJSON: bufferEncode(clientDataJSON),
                                signature: bufferEncode(sig),
                                userHandle: bufferEncode(userHandle),
                            },
                            error: function (xhr) {
                                document.getElementById("bannerSuccess").style.display = "none";
                                document.getElementById("bannerFailure").innerText = "Login failed: " + xhr.responseText;
                                document.getElementById("bannerFailure").style.display = "block";
                                isLoggedIn();
                            }
                        })
                    }).done((data) => {
                        document.getElementById("bannerFailure").style.display = "none";
                        document.getElementById("bannerSuccess").innerText = "Welcome back " + username;
                        document.getElementById("bannerSuccess").style.display = "block";
                        isLoggedIn();
                        return data;
                    })
                }).catch((error) => {
                    document.getElementById("bannerSuccess").style.display = "none";
                    document.getElementById("bannerFailure").innerText = "Login failed: " + error.responseText;
                    document.getElementById("bannerFailure").style.display = "block";
                    isLoggedIn();
                })
        }

    </script>
</body>

</html>